name: Release Extension

on:
    workflow_dispatch:
        inputs:
            dry-run:
                description: 'Dry Run (Build and Zip only, no upload)'
                type: boolean
                required: false
                default: false

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build for Chrome
              run: npm run build

            - name: Build for Firefox
              run: npm run build:firefox

            - name: Zip Chrome Extension
              run: |
                  cd .output/chrome-mv3
                  zip -r ../../extension-chrome.zip .
                  cd ../..

            - name: Zip Firefox Extension
              run: |
                  cd .output/firefox-mv2
                  zip -r ../../extension-firefox.zip .
                  cd ../..

            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: extension-builds
                  path: |
                      extension-chrome.zip
                      extension-firefox.zip

    publish-chrome:
        needs: build
        if: ${{ github.event.inputs.dry-run != 'true' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/download-artifact@v4
              with:
                  name: extension-builds

            - name: Upload to Chrome Web Store
              uses: mnao305/chrome-extension-upload@v5.0.0
              with:
                  file-path: extension-chrome.zip
                  extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
                  client-id: ${{ secrets.GOOGLE_CLIENT_ID }}
                  client-secret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
                  refresh-token: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
                  publish: true # Set to false if you want to manually publish after upload

    publish-firefox:
        needs: build
        if: ${{ github.event.inputs.dry-run != 'true' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4 # Required for web-ext to read manifest if needed, though we are using built artifact

            - uses: actions/download-artifact@v4
              with:
                  name: extension-builds

            - name: Create Artifacts Directory
              run: mkdir -p web-ext-artifacts

            - name: Sign and Upload to Firefox Add-ons
              uses: kewisch/action-web-ext@v1
              with:
                  cmd: sign
                  source: extension-firefox.zip
                  channel: listed
                  apiKey: ${{ secrets.FIREFOX_API_KEY }}
                  apiSecret: ${{ secrets.FIREFOX_API_SECRET }}
                  timeout: 900000
